<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Managing Derivatives · Shrine</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="This guide shows how to add, create, update, and remove [derivatives] for an "/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Managing Derivatives · Shrine"/><meta property="og:type" content="website"/><meta property="og:url" content="https://shrinerb.com/"/><meta property="og:description" content="This guide shows how to add, create, update, and remove [derivatives] for an "/><meta property="og:image" content="https://shrinerb.com/img/logo.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://shrinerb.com/img/logo.png"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-149836844-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/version.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Shrine"/><h2 class="headerTitleWithLogo">Shrine</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/getting-started" target="_self">Guides</a></li><li class=""><a href="/docs/plugins/activerecord" target="_self">Plugins</a></li><li class=""><a href="/docs/external/extensions" target="_self">External</a></li><li class=""><a href="https://discourse.shrinerb.com" target="_blank">Discourse</a></li><li class=""><a href="https://github.com/shrinerb/shrine" target="_blank">GitHub</a></li><li class=""><a href="https://github.com/shrinerb/shrine/wiki" target="_blank">Wiki</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Migrating</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/advantages">Advantages of Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/getting-started">Getting Started</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Base</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/design">The Design of Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/retrieving-uploads">Retrieving Uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/attacher">Using Attacher</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Storage</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/storage/file-system">File System</a></li><li class="navListItem"><a class="navItem" href="/docs/storage/s3">AWS S3</a></li><li class="navListItem"><a class="navItem" href="/docs/storage/memory">Memory</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Features</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/direct-s3">Direct Uploads to S3</a></li><li class="navListItem"><a class="navItem" href="/docs/metadata">Extracting Metadata</a></li><li class="navListItem"><a class="navItem" href="/docs/processing">File Processing</a></li><li class="navListItem"><a class="navItem" href="/docs/validation">File Validation</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extras</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/multiple-files">Multiple Files</a></li><li class="navListItem"><a class="navItem" href="/docs/securing-uploads">Securing Uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/testing">Testing with Shrine</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Migrating</h3><ul class=""><li class="navListItem navListItemActive"><a class="navItem" href="/docs/changing-derivatives">Managing Derivatives</a></li><li class="navListItem"><a class="navItem" href="/docs/changing-location">Migrating File Locations</a></li><li class="navListItem"><a class="navItem" href="/docs/changing-storage">Migrating File Storage</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extending</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/creating-plugins">Writing a Plugin</a></li><li class="navListItem"><a class="navItem" href="/docs/creating-persistence-plugins">Writing a Persistence Plugin</a></li><li class="navListItem"><a class="navItem" href="/docs/creating-storages">Writing a Storage</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Upgrading</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/upgrading-to-3">Upgrading to Shrine 3.x</a></li><li class="navListItem"><a class="navItem" href="/docs/carrierwave">Upgrading from CarrierWave</a></li><li class="navListItem"><a class="navItem" href="/docs/paperclip">Upgrading from Paperclip</a></li><li class="navListItem"><a class="navItem" href="/docs/refile">Upgrading from Refile</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/shrinerb/shrine/edit/master/doc/changing_derivatives.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 class="postHeaderTitle">Managing Derivatives</h1></header><article><div><span><p>This guide shows how to add, create, update, and remove <a href="https://shrinerb.com/docs/plugins/derivatives">derivatives</a> for an
app in production already handling file attachments, with zero downtime.</p>
<p>Let's assume we have a <code>Photo</code> model with an <code>image</code> file attachment. The
examples will be showing image thumbnails, but the advice applies to any kind
of derivatives.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivatives</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>activerecord</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">Photo<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;ActiveRecord::Base</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Attachment</span><span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="adding-derivatives"></a><a href="#adding-derivatives" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Adding derivatives</h2>
<p><em>Scenario: Your app is currently working only with original files, and you want
to introduce derivatives.</em></p>
<p>You'll first want to start creating the derivatives in production, without yet
generating URLs for them (because existing attachments won't yet have
derivatives generated). Let's assume you're generating image thumbnails:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;1.8<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing/mini_magick<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>derivatives&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;magick&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">ImageProcessing</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">MiniMagick</span><span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>original<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;generate&nbsp;the&nbsp;thumbnails&nbsp;you&nbsp;want&nbsp;here&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">small<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;magick<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">300</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">300</span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">medium<span class="punctuation definition constant ruby">:</span></span>&nbsp;magick<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">500</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">large<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;magick<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">800</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">800</span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span>photo_params<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_derivatives!&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;generate&nbsp;derivatives&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>save</span></div></code></pre>
<p>Once we've deployed this to production, we can run the following script to
generate derivatives for all existing attachments in production. It fetches the
records in batches, downloads attachments on permanent storage, creates
derivatives, and persists the changes.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span>find_each&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">photo</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;photo<span class="punctuation separator method ruby">.</span>image_attacher</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control pseudo-method ruby">next</span>&nbsp;<span class="keyword control ruby">unless</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>stored?</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>create_derivatives</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">begin</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_persist&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;persist&nbsp;changes&nbsp;if&nbsp;attachment&nbsp;has&nbsp;not&nbsp;changed&nbsp;in&nbsp;the&nbsp;meantime&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">rescue</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">AttachmentChanged</span><span class="punctuation separator object ruby">,</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;attachment&nbsp;has&nbsp;changed&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">ActiveRecord</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">RecordNotFound</span>&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;record&nbsp;has&nbsp;been&nbsp;deleted&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>delete_derivatives&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;delete&nbsp;now&nbsp;orphaned&nbsp;derivatives&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>Now all attachments should have correctly generated derivatives. You can update
the attachment URLs to use derivatives as needed.</p>
<h2><a class="anchor" aria-hidden="true" id="reprocessing-all-derivatives"></a><a href="#reprocessing-all-derivatives" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reprocessing all derivatives</h2>
<p><em>Scenario: The processing logic has changed for all or most derivatives, and
now you want to reprocess them for existing attachments.</em></p>
<p>Let's assume we've made the following change and have deployed it to production:</p>
<pre><code class="language-diff"><div class="line"><span class="source diff">&nbsp;Attacher.derivatives&nbsp;do&nbsp;|original|</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;magick&nbsp;=&nbsp;ImageProcessing::MiniMagick.source(original)</span></div><div class="line"><span class="source diff"><span class="markup inserted diff"><span class="punctuation definition inserted diff">+</span>&nbsp;&nbsp;&nbsp;.saver(quality:&nbsp;85)</span></span></div><div class="line"><span class="source diff">&nbsp;</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;{</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;small:&nbsp;&nbsp;magick.resize_to_limit!(300,&nbsp;300),</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;medium:&nbsp;magick.resize_to_limit!(500,&nbsp;500),</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large:&nbsp;&nbsp;magick.resize_to_limit!(800,&nbsp;800),</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;}</span></div><div class="line"><span class="source diff">&nbsp;end</span></div></code></pre>
<p>We can now run the following script to reprocess derivatives for all existing
records. It fetches the records in batches, downloads attachments on permanent
storage, reprocesses new derivatives, persists the changes, and deletes old
derivatives.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span>find_each&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">photo</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;photo<span class="punctuation separator method ruby">.</span>image_attacher</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control pseudo-method ruby">next</span>&nbsp;<span class="keyword control ruby">unless</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>stored?</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;old_derivatives&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>derivatives</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>set_derivatives<span class="punctuation section function ruby">(</span><span class="punctuation section scope begin ruby">{</span><span class="punctuation section scope end ruby">}</span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;clear&nbsp;derivatives&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>create_derivatives&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;reprocess&nbsp;derivatives&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">begin</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_persist&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;persist&nbsp;changes&nbsp;if&nbsp;attachment&nbsp;has&nbsp;not&nbsp;changed&nbsp;in&nbsp;the&nbsp;meantime&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>delete_derivatives<span class="punctuation section function ruby">(</span>old_derivatives<span class="punctuation section function ruby">)</span>&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;delete&nbsp;old&nbsp;derivatives&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">rescue</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">AttachmentChanged</span><span class="punctuation separator object ruby">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;attachment&nbsp;has&nbsp;changed&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">ActiveRecord</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">RecordNotFound</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;record&nbsp;has&nbsp;been&nbsp;deleted&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>delete_derivatives&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;delete&nbsp;now&nbsp;orphaned&nbsp;derivatives&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="reprocessing-certain-derivatives"></a><a href="#reprocessing-certain-derivatives" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reprocessing certain derivatives</h2>
<p><em>Scenario: The processing logic has changed for specific derivatives, and now
you want to reprocess them for existing attachments.</em></p>
<p>Let's assume we've made a following change and have deployed it to production:</p>
<pre><code class="language-diff"><div class="line"><span class="source diff">&nbsp;Attacher.derivatives&nbsp;do&nbsp;|original|</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;magick&nbsp;=&nbsp;ImageProcessing::MiniMagick.source(original)</span></div><div class="line"><span class="source diff">&nbsp;</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;{</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;small:&nbsp;&nbsp;magick.resize_to_limit!(300,&nbsp;300),</span></div><div class="line"><span class="source diff"><span class="markup deleted diff"><span class="punctuation definition deleted diff">-</span>&nbsp;&nbsp;&nbsp;&nbsp;medium:&nbsp;magick.resize_to_limit!(500,&nbsp;500),</span></span></div><div class="line"><span class="source diff"><span class="markup inserted diff"><span class="punctuation definition inserted diff">+</span>&nbsp;&nbsp;&nbsp;&nbsp;medium:&nbsp;magick.resize_to_limit!(600,&nbsp;600),</span></span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large:&nbsp;&nbsp;magick.resize_to_limit!(800,&nbsp;800),</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;}</span></div><div class="line"><span class="source diff">&nbsp;end</span></div></code></pre>
<p>We can now run the following script to reprocess the derivative for all
existing records. It fetches the records in batches, downloads attachments with
derivatives, reprocesses the specific derivative, persists the change, and
deletes old derivative.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span>find_each&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">photo</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;photo<span class="punctuation separator method ruby">.</span>image_attacher</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control pseudo-method ruby">next</span>&nbsp;<span class="keyword control ruby">unless</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>derivatives<span class="punctuation separator method ruby">.</span>key?<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>medium</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;old_medium&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>derivatives<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>medium</span><span class="punctuation section array end ruby">]</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;new_medium&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>file<span class="punctuation separator method ruby">.</span>download&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">ImageProcessing</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">MiniMagick</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>original<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">600</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">600</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>add_derivative<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>medium</span><span class="punctuation separator object ruby">,</span>&nbsp;new_medium<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">begin</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_persist&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;persist&nbsp;changes&nbsp;if&nbsp;attachment&nbsp;has&nbsp;not&nbsp;changed&nbsp;in&nbsp;the&nbsp;meantime&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;old_medium<span class="punctuation separator method ruby">.</span>delete&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;delete&nbsp;old&nbsp;derivative&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">rescue</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">AttachmentChanged</span><span class="punctuation separator object ruby">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;attachment&nbsp;has&nbsp;changed&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">ActiveRecord</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">RecordNotFound</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;record&nbsp;has&nbsp;been&nbsp;deleted&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>derivatives<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>medium</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator method ruby">.</span>delete&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;delete&nbsp;now&nbsp;orphaned&nbsp;derivative&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="adding-new-derivatives"></a><a href="#adding-new-derivatives" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Adding new derivatives</h2>
<p><em>Scenario: A new derivative has been added to the processor, and now
you want to add it to existing attachments.</em></p>
<p>Let's assume we've made a following change and have deployed it to production:</p>
<pre><code class="language-diff"><div class="line"><span class="source diff">&nbsp;Attacher.derivatives&nbsp;do&nbsp;|original|</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;magick&nbsp;=&nbsp;ImageProcessing::MiniMagick.source(original)</span></div><div class="line"><span class="source diff">&nbsp;</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;{</span></div><div class="line"><span class="source diff"><span class="markup inserted diff"><span class="punctuation definition inserted diff">+</span>&nbsp;&nbsp;&nbsp;&nbsp;square:&nbsp;magick.resize_to_fill!(150,&nbsp;150),</span></span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;small:&nbsp;&nbsp;magick.resize_to_limit!(300,&nbsp;300),</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;medium:&nbsp;magick.resize_to_limit!(600,&nbsp;600),</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large:&nbsp;&nbsp;magick.resize_to_limit!(800,&nbsp;800),</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;}</span></div><div class="line"><span class="source diff">&nbsp;end</span></div></code></pre>
<p>We can now run following script to add the new derivative for all existing
records. It fetches the records in batches, downloads attachments on permanent
storage, creates the new derivative, and persists the changes.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span>find_each&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">photo</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;photo<span class="punctuation separator method ruby">.</span>image_attacher</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control pseudo-method ruby">next</span>&nbsp;<span class="keyword control ruby">unless</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>stored?</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;square&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>file<span class="punctuation separator method ruby">.</span>download&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">ImageProcessor</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">MiniMagick</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>original<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>resize_to_fill!<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">150</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">150</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>add_derivative<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>square</span><span class="punctuation separator object ruby">,</span>&nbsp;square<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">begin</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_persist&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;persist&nbsp;changes&nbsp;if&nbsp;attachment&nbsp;has&nbsp;not&nbsp;changed&nbsp;in&nbsp;the&nbsp;meantime&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">rescue</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">AttachmentChanged</span><span class="punctuation separator object ruby">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;attachment&nbsp;has&nbsp;changed&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">ActiveRecord</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">RecordNotFound</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;record&nbsp;has&nbsp;been&nbsp;deleted&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>derivatives<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>square</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator method ruby">.</span>delete&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;delete&nbsp;now&nbsp;orphaned&nbsp;derivative&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>Now all attachments should have the new derivative and you can start generating
URLs for it.</p>
<h2><a class="anchor" aria-hidden="true" id="removing-derivatives"></a><a href="#removing-derivatives" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Removing derivatives</h2>
<p><em>Scenario: A derivative isn't being used anymore, so we want to delete it for
existing attachments.</em></p>
<p>Let's assume we've made the following change and have deployed it to production:</p>
<pre><code class="language-diff"><div class="line"><span class="source diff">&nbsp;Attacher.derivatives&nbsp;do&nbsp;|original|</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;magick&nbsp;=&nbsp;ImageProcessing::MiniMagick.source(original)</span></div><div class="line"><span class="source diff">&nbsp;</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;{</span></div><div class="line"><span class="source diff"><span class="markup deleted diff"><span class="punctuation definition deleted diff">-</span>&nbsp;&nbsp;&nbsp;&nbsp;square:&nbsp;magick.resize_to_fill!(150,&nbsp;150),</span></span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;small:&nbsp;&nbsp;magick.resize_to_limit!(300,&nbsp;300),</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;medium:&nbsp;magick.resize_to_limit!(600,&nbsp;600),</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large:&nbsp;&nbsp;magick.resize_to_limit!(800,&nbsp;800),</span></div><div class="line"><span class="source diff">&nbsp;&nbsp;&nbsp;}</span></div><div class="line"><span class="source diff">&nbsp;end</span></div></code></pre>
<p>We can now run following script to remove the unused derivative for all
existing record. It fetches the records in batches, removes and deletes the
unused derivative, and persists the changes.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span>find_each&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">photo</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;photo<span class="punctuation separator method ruby">.</span>image_attacher</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control pseudo-method ruby">next</span>&nbsp;<span class="keyword control ruby">unless</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>derivatives<span class="punctuation separator method ruby">.</span>key?<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>square</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>remove_derivative<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>square</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">delete<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">begin</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_persist&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;persist&nbsp;changes&nbsp;if&nbsp;attachment&nbsp;has&nbsp;not&nbsp;changed&nbsp;in&nbsp;the&nbsp;meantime&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">rescue</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">AttachmentChanged</span><span class="punctuation separator object ruby">,</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;attachment&nbsp;has&nbsp;changed&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">ActiveRecord</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">RecordNotFound</span>&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;record&nbsp;has&nbsp;been&nbsp;deleted&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="backgrounding"></a><a href="#backgrounding" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Backgrounding</h2>
<p>For faster migration, we can also delay any of the operations above into a
background job:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span>find_each&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">photo</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;photo<span class="punctuation separator method ruby">.</span>image_attacher</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control pseudo-method ruby">next</span>&nbsp;<span class="keyword control ruby">unless</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>stored?</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">MakeChangeJob</span><span class="punctuation separator method ruby">.</span>perform_async<span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>record<span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>record<span class="punctuation separator method ruby">.</span>id<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>file_data<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">MakeChangeJob</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">Sidekiq</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Worker</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">perform</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">attacher_class</span>,&nbsp;<span class="variable parameter function ruby">record_class</span>,&nbsp;<span class="variable parameter function ruby">record_id</span>,&nbsp;<span class="variable parameter function ruby">name</span>,&nbsp;<span class="variable parameter function ruby">file_data</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher_class&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>attacher_class<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;record&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>record_class<span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>find<span class="punctuation section function ruby">(</span>record_id<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;if&nbsp;using&nbsp;Active&nbsp;Record&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher_class<span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">model<span class="punctuation definition constant ruby">:</span></span>&nbsp;record<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;name<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;file_data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;make&nbsp;our&nbsp;change&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/testing"><span class="arrow-prev">← </span><span>Testing with Shrine</span></a><a class="docs-next button" href="/docs/changing-location"><span>Migrating File Locations</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#adding-derivatives">Adding derivatives</a></li><li><a href="#reprocessing-all-derivatives">Reprocessing all derivatives</a></li><li><a href="#reprocessing-certain-derivatives">Reprocessing certain derivatives</a></li><li><a href="#adding-new-derivatives">Adding new derivatives</a></li><li><a href="#removing-derivatives">Removing derivatives</a></li><li><a href="#backgrounding">Backgrounding</a></li></ul></nav></div><footer class="nav-footer" id="footer" data-version="3.2.1"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logo.png" alt="Shrine" width="66"/></a><div><h5>Docs</h5><a href="/guides">Guides</a><a href="/plugins">Plugins</a><a href="/external">External</a><a href="https://github.com/shrinerb/shrine/blob/master/CONTRIBUTING.md#readme">Contributing</a></div><div><h5>Community</h5><a href="https://discourse.shrinerb.com" target="_blank" rel="noreferrer noopener">Discourse</a><a href="https://stackoverflow.com/questions/tagged/shrine" target="_blank" rel="noreferrer noopener">Stack Overflow</a></div><div><h5>More</h5><a href="https://twin.github.io">Blog</a><a href="https://github.com/shrinerb/shrine">GitHub</a><a class="github-button" href="https://github.com/shrinerb/shrine" data-icon="octicon-star" data-count-href="/shrinerb/shrine/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="https://twitter.com/shrine_rb" class="twitter-follow-button">Follow @shrine_rb</a></div></div></section><section class="copyright">Copyright © 2020 Janko Marohnić</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '09a11b10801874df7d226df4f2ce8e8f',
                indexName: 'shrinerb',
                inputSelector: '#search_input_react'
              });
            </script></body></html>