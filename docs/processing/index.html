<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>File Processing · Shrine</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Shrine allows you to process attached files eagerly or on-the-fly. For"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="File Processing · Shrine"/><meta property="og:type" content="website"/><meta property="og:url" content="https://shrinerb.com/"/><meta property="og:description" content="Shrine allows you to process attached files eagerly or on-the-fly. For"/><meta property="og:image" content="https://shrinerb.com/img/logo.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://shrinerb.com/img/logo.png"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-149836844-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/version.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Shrine"/><h2 class="headerTitleWithLogo">Shrine</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/getting-started" target="_self">Guides</a></li><li class=""><a href="/docs/plugins/activerecord" target="_self">Plugins</a></li><li class=""><a href="/docs/external/extensions" target="_self">External</a></li><li class=""><a href="https://discourse.shrinerb.com" target="_blank">Discourse</a></li><li class=""><a href="https://github.com/shrinerb/shrine" target="_blank">GitHub</a></li><li class=""><a href="https://github.com/shrinerb/shrine/wiki" target="_blank">Wiki</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Features</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/advantages">Advantages of Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/getting-started">Getting Started</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Base</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/design">The Design of Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/retrieving-uploads">Retrieving Uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/attacher">Using Attacher</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Storage</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/storage/file-system">File System</a></li><li class="navListItem"><a class="navItem" href="/docs/storage/s3">AWS S3</a></li><li class="navListItem"><a class="navItem" href="/docs/storage/memory">Memory</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Features</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/direct-s3">Direct Uploads to S3</a></li><li class="navListItem"><a class="navItem" href="/docs/metadata">Extracting Metadata</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/processing">File Processing</a></li><li class="navListItem"><a class="navItem" href="/docs/validation">File Validation</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extras</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/multiple-files">Multiple Files</a></li><li class="navListItem"><a class="navItem" href="/docs/securing-uploads">Securing Uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/testing">Testing with Shrine</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Migrating</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/changing-derivatives">Managing Derivatives</a></li><li class="navListItem"><a class="navItem" href="/docs/changing-location">Migrating File Locations</a></li><li class="navListItem"><a class="navItem" href="/docs/changing-storage">Migrating File Storage</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extending</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/creating-plugins">Writing a Plugin</a></li><li class="navListItem"><a class="navItem" href="/docs/creating-persistence-plugins">Writing a Persistence Plugin</a></li><li class="navListItem"><a class="navItem" href="/docs/creating-storages">Writing a Storage</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Upgrading</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/upgrading-to-3">Upgrading to Shrine 3.x</a></li><li class="navListItem"><a class="navItem" href="/docs/carrierwave">Upgrading from CarrierWave</a></li><li class="navListItem"><a class="navItem" href="/docs/paperclip">Upgrading from Paperclip</a></li><li class="navListItem"><a class="navItem" href="/docs/refile">Upgrading from Refile</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/shrinerb/shrine/edit/master/doc/processing.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">File Processing</h1></header><article><div><span><p>Shrine allows you to process attached files eagerly or on-the-fly. For
example, if your app is accepting image uploads, you can generate a predefined
set of of thumbnails when the image is attached to a record, or you can have
thumbnails generated dynamically as they're needed.</p>
<p>How you're going to implement processing is entirely up to you. For images it's
recommended to use the <strong><a href="https://github.com/janko/image_processing">ImageProcessing</a></strong> gem, which provides wrappers for
processing with <a href="https://github.com/janko/image_processing/blob/master/doc/minimagick.md#readme">MiniMagick</a> and
<a href="https://github.com/janko/image_processing/blob/master/doc/vips.md#readme">libvips</a>. Here is an example of generating a thumbnail
with ImageProcessing:</p>
<pre><code class="hljs">$ brew install imagemagick
</code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;1.8<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing/mini_magick<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">thumbnail&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">ImageProcessing</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">MiniMagick</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>image<span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;input&nbsp;file&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>resize_to_limit<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">600</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">400</span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;resize&nbsp;macro&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>colorspace<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>grayscale<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;custom&nbsp;operation&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>convert<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>jpeg<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;output&nbsp;type&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>saver<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">quality<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant numeric ruby">90</span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;output&nbsp;options&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>call&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;run&nbsp;the&nbsp;pipeline&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">thumbnail&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Tempfile:...&gt;&nbsp;(a&nbsp;600x400&nbsp;thumbnail&nbsp;of&nbsp;the&nbsp;source&nbsp;image)&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="eager-processing"></a><a href="#eager-processing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Eager processing</h2>
<p>Let's say we're handling images, and want to generate a predefined set of
thumbnails with various dimensions. We can use the
<strong><a href="https://shrinerb.com/docs/plugins/derivatives"><code>derivatives</code></a></strong> plugin to upload and save the processed files:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivatives</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing/mini_magick<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>derivatives&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;magick&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">ImageProcessing</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">MiniMagick</span><span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>original<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">large<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;magick<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">800</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">800</span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">medium<span class="punctuation definition constant ruby">:</span></span>&nbsp;magick<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">500</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">small<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;magick<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">300</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">300</span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">image<span class="punctuation definition constant ruby">:</span></span>&nbsp;file<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">if</span>&nbsp;photo<span class="punctuation separator method ruby">.</span>valid?</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;photo<span class="punctuation separator method ruby">.</span>image_derivatives!&nbsp;<span class="keyword control ruby">if</span>&nbsp;photo<span class="punctuation separator method ruby">.</span>image_changed?&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;creates&nbsp;derivatives&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;photo<span class="punctuation separator method ruby">.</span>save</span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>After the processed files are uploaded, their data is saved into the
<code>&lt;attachment&gt;_data</code> column. You can then retrieve the derivatives as
<a href="http://shrinerb.com/rdoc/classes/Shrine/UploadedFile/InstanceMethods.html"><code>Shrine::UploadedFile</code></a> objects:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&nbsp;...&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>url&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;/uploads/store/lg043.jpg&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;5825949&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>mime_type&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;image/jpeg&quot;&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="conditional-derivatives"></a><a href="#conditional-derivatives" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conditional derivatives</h3>
<p>The <code>Attacher.derivatives</code> block is evaluated in context of a
<code>Shrine::Attacher</code> instance:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>derivatives&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="variable language self ruby">self</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::Attacher&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;file&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;record&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Photo&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;name&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;:image&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;context&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;{&nbsp;...&nbsp;}&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>This gives you the ability to branch the processing logic based on the
attachment information:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>derivatives&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;magick&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">ImageProcessing</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">MiniMagick</span><span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>original<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;result&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">if</span>&nbsp;record<span class="punctuation separator method ruby">.</span>is_a?<span class="punctuation section function ruby">(</span><span class="variable other constant ruby">Photo</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;result<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>jpg</span><span class="punctuation section array end ruby">]</span>&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;magick<span class="punctuation separator method ruby">.</span>convert!<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>jpeg<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;result<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>gray</span><span class="punctuation section array end ruby">]</span>&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;magick<span class="punctuation separator method ruby">.</span>colorspace!<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>grayscale<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">if</span>&nbsp;file<span class="punctuation separator method ruby">.</span>mime_type&nbsp;<span class="keyword operator comparison ruby">==</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image/svg+xml<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;result<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>png</span><span class="punctuation section array end ruby">]</span>&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;magick<span class="punctuation separator method ruby">.</span>loader<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">transparent<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>white<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>convert!<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>png<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;result</span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>The <a href="https://shrinerb.com/docs/plugins/type_predicates"><code>type_predicates</code></a> plugin provides convenient predicate
methods for branching based on the file type.</p>
<h3><a class="anchor" aria-hidden="true" id="backgrounding"></a><a href="#backgrounding" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Backgrounding</h3>
<p>Since file processing can be time consuming, it's recommended to move it into a
background job.</p>
<h4><a class="anchor" aria-hidden="true" id="a-creating-derivatives-with-promotion"></a><a href="#a-creating-derivatives-with-promotion" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A) Creating derivatives with promotion</h4>
<p>The simplest way is to use the <a href="https://shrinerb.com/docs/plugins/backgrounding"><code>backgrounding</code></a> plugin to move
promotion into a background job, and then create derivatives as part of
promotion:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>backgrounding</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>promote_block&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">PromoteJob</span><span class="punctuation separator method ruby">.</span>perform_async<span class="punctuation section function ruby">(</span><span class="variable language self ruby">self</span><span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span>&nbsp;record<span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span>&nbsp;record<span class="punctuation separator method ruby">.</span>id<span class="punctuation separator object ruby">,</span>&nbsp;name<span class="punctuation separator object ruby">,</span>&nbsp;file_data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">PromoteJob</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">Sidekiq</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Worker</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">perform</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">attacher_class</span>,&nbsp;<span class="variable parameter function ruby">record_class</span>,&nbsp;<span class="variable parameter function ruby">record_id</span>,&nbsp;<span class="variable parameter function ruby">name</span>,&nbsp;<span class="variable parameter function ruby">file_data</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher_class&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>attacher_class<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;record&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>record_class<span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>find<span class="punctuation section function ruby">(</span>record_id<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;if&nbsp;using&nbsp;Active&nbsp;Record&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher_class<span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">model<span class="punctuation definition constant ruby">:</span></span>&nbsp;record<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;name<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;file_data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>create_derivatives&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;calls&nbsp;derivatives&nbsp;processor&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_promote</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">rescue</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">AttachmentChanged</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="support class ruby">ActiveRecord</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">RecordNotFound</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;attachment&nbsp;has&nbsp;changed&nbsp;or&nbsp;the&nbsp;record&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;nothing&nbsp;to&nbsp;do&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h4><a class="anchor" aria-hidden="true" id="b-creating-derivatives-separately-from-promotion"></a><a href="#b-creating-derivatives-separately-from-promotion" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>B) Creating derivatives separately from promotion</h4>
<p>Derivatives don't need to be created as part of the attachment flow, you can
create them at any point after promotion:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">DerivativesJob</span><span class="punctuation separator method ruby">.</span>perform_async<span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>record<span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>record<span class="punctuation separator method ruby">.</span>id<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>file_data<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section function ruby">)</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">DerivativesJob</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">Sidekiq</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Worker</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">perform</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">attacher_class</span>,&nbsp;<span class="variable parameter function ruby">record_class</span>,&nbsp;<span class="variable parameter function ruby">record_id</span>,&nbsp;<span class="variable parameter function ruby">name</span>,&nbsp;<span class="variable parameter function ruby">file_data</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher_class&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>attacher_class<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;record&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>record_class<span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>find<span class="punctuation section function ruby">(</span>record_id<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;if&nbsp;using&nbsp;Active&nbsp;Record&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher_class<span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">model<span class="punctuation definition constant ruby">:</span></span>&nbsp;record<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;name<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;file_data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>create_derivatives&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;calls&nbsp;derivatives&nbsp;processor&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_persist</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">rescue</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">AttachmentChanged</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="support class ruby">ActiveRecord</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">RecordNotFound</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="keyword operator arithmetic ruby">&amp;</span><span class="punctuation separator method ruby">.</span>destroy_attached&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;delete&nbsp;now&nbsp;orphaned&nbsp;derivatives&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h4><a class="anchor" aria-hidden="true" id="c-creating-derivatives-concurrently"></a><a href="#c-creating-derivatives-concurrently" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>C) Creating derivatives concurrently</h4>
<p>You can also generate derivatives concurrently:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="variable other constant ruby">THUMBNAILS</span>&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">large<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant numeric ruby">800</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">800</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">medium<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant numeric ruby">500</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">small<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant numeric ruby">300</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">300</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>derivatives&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">name</span>:<span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;thumbnail&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">ImageProcessing</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">MiniMagick</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>original<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span><span class="keyword operator arithmetic ruby">*</span><span class="support class ruby">THUMBNAILS</span><span class="punctuation separator method ruby">.</span>fetch<span class="punctuation section function ruby">(</span>name<span class="punctuation section function ruby">))</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span>name&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;thumbnail&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">ImageUploader</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">THUMBNAILS</span><span class="punctuation separator method ruby">.</span>each_key&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">derivative_name</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">DerivativeJob</span><span class="punctuation separator method ruby">.</span>perform_async<span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>record<span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>record<span class="punctuation separator method ruby">.</span>id<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>file_data<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;derivative_name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">DerivativeJob</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">Sidekiq</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Worker</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">perform</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">attacher_class</span>,&nbsp;<span class="variable parameter function ruby">record_class</span>,&nbsp;<span class="variable parameter function ruby">record_id</span>,&nbsp;<span class="variable parameter function ruby">name</span>,&nbsp;<span class="variable parameter function ruby">file_data</span>,&nbsp;<span class="variable parameter function ruby">derivative_name</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher_class&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>attacher_class<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;record&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>record_class<span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>find<span class="punctuation section function ruby">(</span>record_id<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;if&nbsp;using&nbsp;Active&nbsp;Record&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher_class<span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">model<span class="punctuation definition constant ruby">:</span></span>&nbsp;record<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;name<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;file_data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>create_derivatives<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;derivative_name<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_persist&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">reloaded_attacher</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;override&nbsp;derivatives&nbsp;created&nbsp;in&nbsp;other&nbsp;jobs&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>merge_derivatives<span class="punctuation section function ruby">(</span>reloaded_attacher<span class="punctuation separator method ruby">.</span>derivatives<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">rescue</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">AttachmentChanged</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="support class ruby">ActiveRecord</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">RecordNotFound</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>derivatives<span class="punctuation section array begin ruby">[</span>derivative_name<span class="punctuation section array end ruby">]</span><span class="punctuation separator method ruby">.</span>delete&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;delete&nbsp;now&nbsp;orphaned&nbsp;derivative&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="url-fallbacks"></a><a href="#url-fallbacks" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>URL fallbacks</h3>
<p>If you're creating derivatives in a background job, you'll likely want to use
some fallbacks for derivative URLs while the background job is still
processing. You can do that with the <a href="https://shrinerb.com/docs/plugins/default_url"><code>default_url</code></a> plugin.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>default_url</span></span></div></code></pre>
<h4><a class="anchor" aria-hidden="true" id="a-fallback-to-original"></a><a href="#a-fallback-to-original" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A) Fallback to original</h4>
<p>You can fall back to the original file URL when the derivative is missing:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>default_url&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">derivative</span>:&nbsp;<span class="variable other block ruby">nil</span><span class="punctuation separator variable ruby">,</span>&nbsp;**<span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;file<span class="keyword operator arithmetic ruby">&amp;</span><span class="punctuation separator method ruby">.</span>url&nbsp;<span class="keyword control ruby">if</span>&nbsp;derivative</span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;<span class="markup underline link https hyperlink">https://example.com/path/to/original.jpg</span>&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;background&nbsp;job&nbsp;finishes&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;<span class="markup underline link https hyperlink">https://example.com/path/to/large.jpg</span>&quot;&nbsp;</span></span></div></code></pre>
<h4><a class="anchor" aria-hidden="true" id="b-fallback-to-derivative"></a><a href="#b-fallback-to-derivative" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>B) Fallback to derivative</h4>
<p>You can fall back to another derivative URL when the derivative is missing:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>default_url&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">derivative</span>:&nbsp;<span class="variable other block ruby">nil</span><span class="punctuation separator variable ruby">,</span>&nbsp;**<span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;derivatives<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>optimized</span><span class="punctuation section array end ruby">]</span><span class="keyword operator arithmetic ruby">&amp;</span><span class="punctuation separator method ruby">.</span>url&nbsp;<span class="keyword control ruby">if</span>&nbsp;derivative</span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;<span class="markup underline link https hyperlink">https://example.com/path/to/optimized.jpg</span>&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;background&nbsp;job&nbsp;finishes&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;<span class="markup underline link https hyperlink">https://example.com/path/to/large.jpg</span>&quot;&nbsp;</span></span></div></code></pre>
<h4><a class="anchor" aria-hidden="true" id="c-fallback-to-on-the-fly"></a><a href="#c-fallback-to-on-the-fly" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>C) Fallback to on-the-fly</h4>
<p>You can also fall back to <a href="#on-the-fly-processing">on-the-fly processing</a>,
which should generally provide the best user experience.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="variable other constant ruby">THUMBNAILS</span>&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">small<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant numeric ruby">300</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">300</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">medium<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant numeric ruby">500</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">large<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant numeric ruby">800</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">800</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>default_url&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">derivative</span>:&nbsp;<span class="variable other block ruby">nil</span><span class="punctuation separator variable ruby">,</span>&nbsp;**<span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;file<span class="keyword operator arithmetic ruby">&amp;</span><span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">*</span><span class="support class ruby">THUMBNAILS</span><span class="punctuation separator method ruby">.</span>fetch<span class="punctuation section function ruby">(</span>derivative<span class="punctuation section function ruby">))</span>&nbsp;<span class="keyword control ruby">if</span>&nbsp;derivative</span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;../derivations/thumbnail/800/800/...&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;background&nbsp;job&nbsp;finishes&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;<span class="markup underline link https hyperlink">https://example.com/path/to/large.jpg</span>&quot;&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="on-the-fly-processing"></a><a href="#on-the-fly-processing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>On-the-fly processing</h2>
<p>Having eagerly created image thumbnails can be a pain to maintain, because
whenever you need to add a new version or change an existing one, you need to
retroactively apply it to all existing attachments (see the <a href="https://shrinerb.com/docs/changing-derivatives">Managing
Derivatives</a> guide for more details).</p>
<p>Sometimes it makes more sense to generate thumbnails dynamically as they're
requested, and then cache them for future requests. This strategy is known as
processing &quot;<strong>on-the-fly</strong>&quot; or &quot;<strong>on-demand</strong>&quot;, and it's suitable for
short-running processing such as creating image thumbnails or document
previews.</p>
<p>Shrine provides on-the-fly processing functionality via the
<strong><a href="https://shrinerb.com/docs/plugins/derivation_endpoint"><code>derivation_endpoint</code></a></strong> plugin. You set it up by
loading the plugin with a secret key and a path prefix, mount its Rack app in
your routes on the configured path prefix, and define processing you want to
perform:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;config/initializers/shrine.rb&nbsp;(Rails)&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoints</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">secret_key<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>&lt;YOUR_SECRET_KEY&gt;<span class="punctuation definition string end ruby">&quot;</span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing/mini_magick<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">prefix<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>derivations/image<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;matches&nbsp;mount&nbsp;point&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;derivation&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">file</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">width</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">height</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">ImageProcessing</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">MiniMagick</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>file<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span>width<span class="punctuation separator method ruby">.</span>to_i<span class="punctuation separator object ruby">,</span>&nbsp;height<span class="punctuation separator method ruby">.</span>to_i<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;config/routes.rb&nbsp;(Rails)&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Rails</span><span class="punctuation separator method ruby">.</span>application<span class="punctuation separator method ruby">.</span>routes<span class="punctuation separator method ruby">.</span>draw&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;mount&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator method ruby">.</span>derivation_endpoint&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/derivations/image<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>Now you can generate thumbnail URLs from attached files, and the actual
thumbnail will be generated when the URL is requested:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">600</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">400</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;/derivations/image/thumbnail/600/400/eyJpZCI6ImZvbyIsInN0b3JhZ2UiOiJzdG9yZSJ9?signature=...&quot;&nbsp;</span></span></div></code></pre>
<p>The plugin is highly customizable, be sure to check out the
<a href="https://shrinerb.com/docs/plugins/derivation_endpoint">documentation</a>, especially the <a href="https://shrinerb.com/docs/plugins/derivation_endpoint#performance">performance
section</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="dynamic-derivation"></a><a href="#dynamic-derivation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dynamic derivation</h3>
<p>If you have multiple types of transformations and don't want to have a
derivation for each one, you can set up a single derivation that applies any
series of transformations:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;derivation&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>transform</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">transformations</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;transformations&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>urlsafe_deserialize<span class="punctuation section function ruby">(</span>transformations<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;vips&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">ImageProcessing</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Vips</span><span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>original<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;vips<span class="punctuation separator method ruby">.</span>apply!<span class="punctuation section function ruby">(</span>transformations<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation separator method ruby">.</span>derivation_url&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>transform</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>urlsafe_serialize<span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">crop<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant numeric ruby">10</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">10</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">resize_to_fit<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant numeric ruby">300</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">300</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">gaussblur<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant numeric ruby">1</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section function ruby">)</span></span></div></code></pre>
<p>You can create a helper method for convenience:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">derivation_url</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">file</span>,&nbsp;<span class="variable parameter function ruby">transformations</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;file<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>transform</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>urlsafe_serialize<span class="punctuation section function ruby">(</span>transformations<span class="punctuation section function ruby">))</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">derivation_url&nbsp;photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">crop<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant numeric ruby">10</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">10</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">resize_to_fit<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant numeric ruby">300</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">300</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">gaussblur<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant numeric ruby">1</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="processing-other-filetypes"></a><a href="#processing-other-filetypes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Processing other filetypes</h2>
<p>So far we've only been talking about processing images. However, there is
nothing image-specific in Shrine's processing API, you can just as well process
any other types of files. The processing tool doesn't need to have any special
Shrine integration, the ImageProcessing gem that we saw earlier is a completely
generic gem.</p>
<p>To demonstrate, here is an example of transcoding videos using
<a href="https://github.com/streamio/streamio-ffmpeg">streamio-ffmpeg</a>:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>streamio-ffmpeg<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>streamio-ffmpeg<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">VideoUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>derivatives&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;transcoded&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Tempfile</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span>&nbsp;<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>transcoded<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>.mp4<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;screenshot&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Tempfile</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span>&nbsp;<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>screenshot<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>.jpg<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;movie&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">FFMPEG</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Movie</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span>original<span class="punctuation separator method ruby">.</span>path<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;movie<span class="punctuation separator method ruby">.</span>transcode<span class="punctuation section function ruby">(</span>transcoded<span class="punctuation separator method ruby">.</span>path<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;movie<span class="punctuation separator method ruby">.</span>screenshot<span class="punctuation section function ruby">(</span>screenshot<span class="punctuation separator method ruby">.</span>path<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">transcoded<span class="punctuation definition constant ruby">:</span></span>&nbsp;transcoded<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">screenshot<span class="punctuation definition constant ruby">:</span></span>&nbsp;screenshot&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="polymorphic-uploader"></a><a href="#polymorphic-uploader" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Polymorphic uploader</h3>
<p>Sometimes you might want an attachment attribute to accept multiple types of
files, and apply different processing depending on the type. Since Shrine's
processing blocks are evaluated dynamically, you can use conditional logic:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">PolymorphicUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="variable other constant ruby">IMAGE_TYPES</span>&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="string quoted other ruby"><span class="punctuation section array begin ruby">%w[</span>image/jpeg&nbsp;image/png&nbsp;image/webp<span class="punctuation section array end ruby">]</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="variable other constant ruby">VIDEO_TYPES</span>&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="string quoted other ruby"><span class="punctuation section array begin ruby">%w[</span>video/mp4&nbsp;video/quicktime<span class="punctuation section array end ruby">]</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="variable other constant ruby">PDF_TYPES</span>&nbsp;&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="string quoted other ruby"><span class="punctuation section array begin ruby">%w[</span>application/pdf<span class="punctuation section array end ruby">]</span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>validate&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;validate_mime_type&nbsp;<span class="variable other constant ruby">IMAGE_TYPES</span>&nbsp;<span class="keyword operator arithmetic ruby">+</span>&nbsp;<span class="variable other constant ruby">VIDEO_TYPES</span>&nbsp;<span class="keyword operator arithmetic ruby">+</span>&nbsp;<span class="variable other constant ruby">PDF_TYPES</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>derivatives&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">case</span>&nbsp;file<span class="punctuation separator method ruby">.</span>mime_type</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">when</span>&nbsp;<span class="keyword operator arithmetic ruby">*</span><span class="variable other constant ruby">IMAGE_TYPES</span>&nbsp;<span class="keyword control ruby">then</span>&nbsp;process_derivatives<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation separator object ruby">,</span>&nbsp;original<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">when</span>&nbsp;<span class="keyword operator arithmetic ruby">*</span><span class="variable other constant ruby">VIDEO_TYPES</span>&nbsp;<span class="keyword control ruby">then</span>&nbsp;process_derivatives<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>video</span><span class="punctuation separator object ruby">,</span>&nbsp;original<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">when</span>&nbsp;<span class="keyword operator arithmetic ruby">*</span><span class="variable other constant ruby">PDF_TYPES</span>&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">then</span>&nbsp;process_derivatives<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>pdf</span><span class="punctuation separator object ruby">,</span>&nbsp;&nbsp;&nbsp;original<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>derivatives&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>derivatives&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>video</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>derivatives&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>pdf</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="extras"></a><a href="#extras" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Extras</h2>
<h3><a class="anchor" aria-hidden="true" id="automatic-derivatives"></a><a href="#automatic-derivatives" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Automatic derivatives</h3>
<p>If you would like derivatives to be automatically created with promotion, you
can override <code>Attacher#promote</code> for call <code>Attacher#create_derivatives</code> before
promotion:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">Shrine::Attacher</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">promote</span><span class="punctuation definition parameters ruby">(</span><span class="keyword operator arithmetic ruby">*</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;create_derivatives</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control pseudo-method ruby">super</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>This shouldn't be needed if you're processing in the
<a href="#backgrounding">background</a>, as in that case you have a background worker that
will be called for each attachment, so you can call
<code>Attacher#create_derivatives</code> there.</p>
<h3><a class="anchor" aria-hidden="true" id="libvips"></a><a href="#libvips" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>libvips</h3>
<p>As mentioned, ImageProcessing gem also has an alternative backend for
processing images with <strong><a href="https://libvips.github.io/libvips/">libvips</a></strong>. libvips is a full-featured image
processing library like ImageMagick, with impressive performance
characteristics – it's often <strong>multiple times faster</strong> than ImageMagick and has
low memory usage (see <a href="https://github.com/libvips/libvips/wiki/Why-is-libvips-quick">Why is libvips quick</a>).</p>
<p>Using libvips is as easy as installing it and switching to the
<a href="https://github.com/janko/image_processing/blob/master/doc/vips.md#readme"><code>ImageProcessing::Vips</code></a> backend:</p>
<pre><code class="hljs">$ brew install vips
</code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;1.8<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing/vips<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;all&nbsp;we&nbsp;did&nbsp;was&nbsp;replace&nbsp;`ImageProcessing::MiniMagick`&nbsp;with&nbsp;`ImageProcessing::Vips`&nbsp;</span></span></div><div class="line"><span class="source ruby">thumbnail&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">ImageProcessing</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Vips</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>image<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">600</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">400</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">thumbnail&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Tempfile:...&gt;&nbsp;(a&nbsp;600x400&nbsp;thumbnail&nbsp;of&nbsp;the&nbsp;source&nbsp;image)&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="parallelize-uploads"></a><a href="#parallelize-uploads" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Parallelize uploads</h3>
<p>If you're generating derivatives, you can parallelize the uploads using the
<a href="https://github.com/ruby-concurrency/concurrent-ruby">concurrent-ruby</a> gem:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>concurrent-ruby<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>concurrent<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">derivatives&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>process_derivatives</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">tasks&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;derivatives<span class="punctuation separator method ruby">.</span>map&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">name</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">file</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Concurrent</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Promises</span><span class="punctuation separator method ruby">.</span>future<span class="punctuation section function ruby">(</span>name<span class="punctuation separator object ruby">,</span>&nbsp;file<span class="punctuation section function ruby">)</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">name</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">file</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>add_derivative<span class="punctuation section function ruby">(</span>name<span class="punctuation separator object ruby">,</span>&nbsp;file<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="support class ruby">Concurrent</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Promises</span><span class="punctuation separator method ruby">.</span>zip<span class="punctuation section function ruby">(</span><span class="keyword operator arithmetic ruby">*</span>tasks<span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>wait!</span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="external-processing"></a><a href="#external-processing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>External processing</h3>
<p>You can also integrate Shrine with 3rd-party processing services such as
<a href="https://cloudinary.com/">Cloudinary</a> and <a href="https://www.imgix.com/">Imgix</a>. In the most common case, you'd serve images directly
from these services, see the corresponding plugin docs for more details
(<a href="https://github.com/shrinerb/shrine-cloudinary">shrine-cloudinary</a>, <a href="https://github.com/shrinerb/shrine-imgix">shrine-imgix</a> and <a href="https://shrinerb.com/docs/external/extensions#storages">others</a>)</p>
<p>You can also choose to use these services as an implementation detail of your
application, by downloading the processed images and saving them to your
storage. Here is how you might store files processed by Imgix as derivatives:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>down<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;5.0<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>http<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;4.0<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>shrine-imgix<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;0.5<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivatives</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>imgix</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">client<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">host<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>my-app.imgix.net<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">secure_url_token<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>secret<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>down/http<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="variable other constant ruby">IMGIX_THUMBNAIL</span>&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section function ruby">(</span>file<span class="punctuation separator object ruby">,</span>&nbsp;width<span class="punctuation separator object ruby">,</span>&nbsp;height<span class="punctuation section function ruby">)</span>&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">Down</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Http</span><span class="punctuation separator method ruby">.</span>download<span class="punctuation section function ruby">(</span>file<span class="punctuation separator method ruby">.</span>imgix_url<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">w<span class="punctuation definition constant ruby">:</span></span>&nbsp;width<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">h<span class="punctuation definition constant ruby">:</span></span>&nbsp;height<span class="punctuation section function ruby">))</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>derivatives&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">large<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;<span class="support class ruby">IMGIX_THUMBNAIL</span><span class="punctuation section array begin ruby">[</span>file<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">800</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">800</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">medium<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="support class ruby">IMGIX_THUMBNAIL</span><span class="punctuation section array begin ruby">[</span>file<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">small<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;<span class="support class ruby">IMGIX_THUMBNAIL</span><span class="punctuation section array begin ruby">[</span>file<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">300</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">300</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/metadata"><span class="arrow-prev">← </span><span>Extracting Metadata</span></a><a class="docs-next button" href="/docs/validation"><span>File Validation</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#eager-processing">Eager processing</a><ul class="toc-headings"><li><a href="#conditional-derivatives">Conditional derivatives</a></li><li><a href="#backgrounding">Backgrounding</a></li><li><a href="#url-fallbacks">URL fallbacks</a></li></ul></li><li><a href="#on-the-fly-processing">On-the-fly processing</a><ul class="toc-headings"><li><a href="#dynamic-derivation">Dynamic derivation</a></li></ul></li><li><a href="#processing-other-filetypes">Processing other filetypes</a><ul class="toc-headings"><li><a href="#polymorphic-uploader">Polymorphic uploader</a></li></ul></li><li><a href="#extras">Extras</a><ul class="toc-headings"><li><a href="#automatic-derivatives">Automatic derivatives</a></li><li><a href="#libvips">libvips</a></li><li><a href="#parallelize-uploads">Parallelize uploads</a></li><li><a href="#external-processing">External processing</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer" data-version="3.2.1"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logo.png" alt="Shrine" width="66"/></a><div><h5>Docs</h5><a href="/guides">Guides</a><a href="/plugins">Plugins</a><a href="/external">External</a><a href="https://github.com/shrinerb/shrine/blob/master/CONTRIBUTING.md#readme">Contributing</a></div><div><h5>Community</h5><a href="https://discourse.shrinerb.com" target="_blank" rel="noreferrer noopener">Discourse</a><a href="https://stackoverflow.com/questions/tagged/shrine" target="_blank" rel="noreferrer noopener">Stack Overflow</a></div><div><h5>More</h5><a href="https://twin.github.io">Blog</a><a href="https://github.com/shrinerb/shrine">GitHub</a><a class="github-button" href="https://github.com/shrinerb/shrine" data-icon="octicon-star" data-count-href="/shrinerb/shrine/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="https://twitter.com/shrine_rb" class="twitter-follow-button">Follow @shrine_rb</a></div></div></section><section class="copyright">Copyright © 2020 Janko Marohnić</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '09a11b10801874df7d226df4f2ce8e8f',
                indexName: 'shrinerb',
                inputSelector: '#search_input_react'
              });
            </script></body></html>